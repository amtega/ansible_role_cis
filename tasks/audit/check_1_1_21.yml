---

- name: Read sticky bit on all world-writeable directories
  shell: |-
    set -o pipefail # Raise internal pipe errors
    df --local -P \
    | awk {'if (NR!=1) print $6'} \
    | xargs -I '{}' find '{}' -xdev -type d \( -perm -0002 -a ! -perm -1000 \)

  # In order to get an OK in molecule test:
  # | grep -v --extended-regexp "^/proc|^/sys"\
  # | xargs -I '{}' find '{}' -xdev -type d \( -perm -0002 -a ! -perm -1000 \)
  become: yes
  changed_when: false
  register: sticky_bit_result

- name: Ensure sticky bit is set on all world-writable directories
  assert:
    that: sticky_bit_result.stdout | length == 0
  register: cis_check_result
